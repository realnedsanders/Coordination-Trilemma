name: Create Release

# Create GitHub releases when tags are pushed
# This makes versioned PDFs easily accessible
on:
  push:
    tags:
      - 'v*.*.*'  # Matches v1.0.0, v2.1.3, etc.

permissions:
  contents: write  # Required to create releases
  id-token: write  # Required for Cosign signing

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full git history for build info

      - name: Extract version from tag
        id: version
        run: |
          # Remove 'v' prefix from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull LaTeX Docker image
        run: |
          docker pull ghcr.io/realnedsanders/coordination-trilemma/latex:latest

      - name: Build PDF
        run: |
          make
          ls -lh main.pdf

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign PDF with Cosign
        run: |
          cosign sign-blob --yes \
            --bundle main.pdf.cosign.bundle \
            main.pdf

      - name: Extract PDF metadata
        id: pdf-metadata
        run: |
          # Extract git info for release notes
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release-notes
        run: |
          cat > release-notes.md << 'EOF'
          # The Coordination Trilemma - Version ${{ steps.version.outputs.version }}

          ## ðŸ“„ Published PDF

          Download the cryptographically signed PDF from this release.

          **Build Information:**
          - **Commit:** ${{ steps.pdf-metadata.outputs.commit_sha }}
          - **Built:** ${{ steps.pdf-metadata.outputs.build_date }}
          - **SLSA Level:** 3
          - **Signature:** Cosign keyless signing (see SECURITY.md)

          ## ðŸ” Verification

          **Verify the signature:**
          ```bash
          # Download release assets
          wget https://github.com/realnedsanders/Coordination-Trilemma/releases/download/${{ steps.version.outputs.tag }}/main.pdf
          wget https://github.com/realnedsanders/Coordination-Trilemma/releases/download/${{ steps.version.outputs.tag }}/main.pdf.cosign.bundle

          # Verify with cosign
          cosign verify-blob --bundle main.pdf.cosign.bundle \
            --certificate-identity-regexp="^https://github.com/realnedsanders/Coordination-Trilemma" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            main.pdf
          ```

          See [SECURITY.md](https://github.com/realnedsanders/Coordination-Trilemma/blob/main/SECURITY.md) for complete verification instructions.

          ## ðŸ“– Read Online

          The latest version is always available at:
          - Landing page: https://enlightenment.dev
          - Direct PDF: https://enlightenment.dev/main.pdf

          ## ðŸ“š Citation

          ```
          B. Escalera, A. Escalera. "The Coordination Trilemma: A Formal Analysis of
          Large-Scale Human Cooperation." Version ${{ steps.version.outputs.version }}, 2025.
          https://enlightenment.dev
          ```

          ## ðŸ”— Links

          - [Repository](https://github.com/realnedsanders/Coordination-Trilemma)
          - [Build Documentation](https://github.com/realnedsanders/Coordination-Trilemma/blob/main/docs/BUILD.md)
          - [Security Policy](https://github.com/realnedsanders/Coordination-Trilemma/blob/main/SECURITY.md)
          - [Contributing Guidelines](https://github.com/realnedsanders/Coordination-Trilemma/blob/main/CONTRIBUTING.md)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "Coordination Trilemma v${{ steps.version.outputs.version }}"
          body_path: release-notes.md
          files: |
            main.pdf
            main.pdf.cosign.bundle
          draft: false
          prerelease: false
          generate_release_notes: true  # Append auto-generated changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts for record
        uses: actions/upload-artifact@v4
        with:
          name: coordination-trilemma-release-${{ steps.version.outputs.version }}
          path: |
            main.pdf
            main.pdf.cosign.bundle
          retention-days: 90
